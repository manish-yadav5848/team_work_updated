
from pyspark.sql import SparkSession
from pyspark.sql.functions import *

#primary key-client_id,fund_number,plan_number,fund_iv
#old_PK -client_id,fund_number,plan_number,div_sub_id,fund_iv,fund_id,auto_enroll_date
def transform(spark: SparkSession, primary_key: list):

    exn_xxewre01_xxewrpfd_jb_df = spark.sql("SELECT coalesce(pfd.client_id, '-9999') as client_id,coalesce(nullif(price_id,''),'-9999') as fund_number,coalesce(plan_number, '-9999') as plan_number,coalesce(fund_iv, '-9999') as fund_iv,cast(fo.asset_cd as VARCHAR(8)) as asset_code,cast(null as DATE) as auto_enroll_date,cast(fo.fund_abbr_name as VARCHAR(8)) as fund_abbr_name,cast(fo.acc_fund_ind as VARCHAR(1)) as acc_fund_indicator,accounting_method_indicator,cast(fo.adj_price_ind as VARCHAR(1)) as fund_adj_price_indicator,CAST(null as decimal(13,4)) as adm_fee_d_fct, CAST(fo.adm_fee_rate as decimal(13,4)) as adm_fee_rate,cast(fo.adm_fund_num as VARCHAR(3)) as adm_fund_num,CAST(fo.advr_fee_d_fct as decimal(13,4)) as advr_fee_d_fct,CAST(fo.adm_fee_d_fct as decimal(13,4)) as advr_fee_rate,cast(fo.aet_ser_p_ind as VARCHAR(1)) as fund_aet_ser_p_indicator,cast(fo.asset_class as VARCHAR(8)) as stmt_asset_class,cast(at_file_ind as VARCHAR(245)) as at_file_ind,cast(null as VARCHAR(1)) as auto_enroll_indicator,CAST(fo.auv_move_dt as date) as auv_move_date,CAST(fo.avail_prod_dt as date) as fund_avail_prod,cast(null as DECIMAL(11,6)) as default_deferral_amount,cast(null as DECIMAL(11,6)) as default_deferral_percent,cast(null as DECIMAL(11,6)) as default_invest_election_pct,cast(fo.div_payfreq_cd as VARCHAR(1)) as div_payfreq_cd,dividend_pass_thru_option,cast(dividend_rate as DECIMAL(13,10)) as dividend_rate,cast(dividend_record_date as DATE) as dividend_record_date,cast(dividend_reinvest_date as DATE) as dividend_reinvest_date,equivalent_shares_factor,cast(fo.exped_fund_ind as VARCHAR(1)) as exped_indicator, cast(fo.fam_abbr_name as VARCHAR(8)) as fund_family_abbr_name,cast(fo.fixed_fund_ind as VARCHAR(1)) as fixed_fund_indicator,cast(fo.fixed_fund_typ as VARCHAR(1)) as fixed_typ,cast(fractional_indicator as INTEGER) as fractional_share_ind, pfd.fund_name,cast(null as VARCHAR(30)) as fund_separate_account,group_fund_indicator,cast(fo.incept_dt as DATE) as fund_inception_date,CAST(fo.incept_ind as VARCHAR(1)) as fund_inception_indicator,cast(fo.index_id as VARCHAR(10)) as fund_index_id,investment_asset_type,investment_manager_id,investment_name_long_version,investment_type,cast(fo.invst_style as VARCHAR(30)) as invst_style,CAST(fo.m_d_div_amt_hi as decimal(13,4)) as m_d_div_amt_hi,CAST(fo.m_d_div_amt_lo as decimal(13,4)) as m_d_div_amt_lo,cast(fo.m_d_div_day as VARCHAR(1)) as m_d_div_day,cast(fo.mid_fund_name as VARCHAR(40)) as mid_fund_name,CAST(fo.outsd_fund_num as VARCHAR(8)) as outsd_fund_num,cast(fo.perf_ind as VARCHAR(1)) as fund_perf_indicator,full_price_id as  price_id,cast(proportional_percentage as DECIMAL(3,2)) as proportional_percentage,CAST(fo.prt_fee_fct as decimal(13,4)) as prt_fee_fct,CAST(fo.prt_fee_rate as decimal(13,4)) as prt_fee_rate,cast(qualified_stock_fund_indicator as VARCHAR(1)) as qualified_stock_fund_indicator,CAST(fo.risk_rtn as INTEGER) as fund_risk_rtn,CAST(fo.s_d_div_amt_hi as decimal(13,4)) as s_d_div_amt_hi,CAST(fo.s_d_div_amt_lo as decimal(13,4)) as s_d_div_amt_lo,cast(fo.sadv_fee_d_fct as DECIMAL(13,4)) as sadv_fee_d_fct,cast(fo.sadv_fee_rate as DECIMAL(13,4)) as sadv_fee_rate,cast(share_price_ind as VARCHAR(1)) as share_price_indicator,case when source_cycle_date >= to_date('0001-01-01') and source_cycle_date <= to_date('9999-12-31') then cast(source_cycle_date as date) else null end as source_cycle_date,cast(null as DATE) as source_processing_date,'VRP-SP' as source_system,cast(fo.stk_fund_ind as VARCHAR(1)) as stk_indicator,cast(unit_share_price as DECIMAL(11,6)) as share_price,ticker_symbol,cast(fo.trd_inst_ffam as VARCHAR(40)) as trd_inst_ffam,cast(trust_number as VARCHAR(6)) as trust_number,cast(null as VARCHAR(1)) as shares,cast(value_of_one_share as DECIMAL(11,6)) as single_share_value,CAST(fo.yb04_d_fct as decimal(13,4)) as yb04_d_fct,CAST(fo.yb04_rate as decimal(5,2)) as yb04_rate,cast(fo.mktg_fund_number as VARCHAR(4)) as mktg_fund_number,fo.fund_name as fund_ops_fund_name, stabilizer_gb_fun_investment_id_contract_number as stabi_fund_invest_contract_num FROM exn_xxewre01_xxewrpfd_jb pfd left outer join FO_FUND_TXT fo on coalesce(pfd.price_id,'-9999')=coalesce(fo.fund_number,'-9999') or coalesce(concat('0',pfd.price_id),'-9999')=coalesce(fo.fund_number,'-9999') order by client_id desc")

    exn_xxewre01_xxewrpfd_ng_df = spark.sql("SELECT coalesce(pfd.client_id, '-9999') as client_id, coalesce(nullif(fund_code, ''), '-9999') as fund_number, coalesce(pfd.plan_number, '-9999') as plan_number, coalesce(fund_iv, '-9999') as fund_iv, cast(fo.asset_cd as VARCHAR(8)) as asset_code, cast(aef.auto_enroll_date as DATE) as auto_enroll_date, cast(fo.fund_abbr_name as VARCHAR(8)) as fund_abbr_name, cast(fo.acc_fund_ind as VARCHAR(1)) as acc_fund_indicator, accounting_method_indicator, cast(fo.adj_price_ind as VARCHAR(1)) as fund_adj_price_indicator, CAST(null as decimal(13, 4)) as adm_fee_d_fct, CAST(fo.adm_fee_rate as decimal(13, 4)) as adm_fee_rate, cast(fo.adm_fund_num as VARCHAR(3)) as adm_fund_num, CAST(fo.advr_fee_d_fct as decimal(13, 4)) as advr_fee_d_fct, CAST(fo.adm_fee_d_fct as decimal(13, 4)) as advr_fee_rate, cast(fo.aet_ser_p_ind as VARCHAR(1)) as fund_aet_ser_p_indicator, cast(fo.asset_class as VARCHAR(8)) as stmt_asset_class, cast(at_file_ind as VARCHAR(245)) as at_file_ind, cast(null as VARCHAR(1)) as auto_enroll_indicator, CAST(fo.auv_move_dt as date) as auv_move_date, CAST(fo.avail_prod_dt as date) as fund_avail_prod, cast(aef.default_deferral_amount as DECIMAL(11, 6)) as default_deferral_amount, cast(default_deferral_percent as DECIMAL(11, 6)) as default_deferral_percent, cast( aef.default_investment_election_percent as DECIMAL(11, 6) ) as default_invest_election_pct, cast(fo.div_payfreq_cd as VARCHAR(1)) as div_payfreq_cd, dividend_pass_thru_option, cast(dividend_rate as DECIMAL(13, 10)) as dividend_rate, cast(dividend_record_date as DATE) as dividend_record_date, cast(dividend_reinvest_date as DATE) as dividend_reinvest_date, equivalent_shares_factor, cast(fo.exped_fund_ind as VARCHAR(1)) as exped_indicator, cast(fo.fam_abbr_name as VARCHAR(8)) as fund_family_abbr_name, cast(fo.fixed_fund_ind as VARCHAR(1)) as fixed_fund_indicator, cast(fo.fixed_fund_typ as VARCHAR(1)) as fixed_typ, cast(fractional_indicator as INTEGER) as fractional_share_ind, pfd.fund_name, cast(null as VARCHAR(30)) as fund_separate_account, group_fund_indicator, cast(fo.incept_dt as DATE) as fund_inception_date, CAST(fo.incept_ind as VARCHAR(1)) as fund_inception_indicator, cast(fo.index_id as VARCHAR(10)) as fund_index_id, investment_asset_type, investment_manager_id, investment_name_long_version, investment_type, cast(fo.invst_style as VARCHAR(30)) as invst_style, CAST(fo.m_d_div_amt_hi as decimal(13, 4)) as m_d_div_amt_hi, CAST(fo.m_d_div_amt_lo as decimal(13, 4)) as m_d_div_amt_lo, cast(fo.m_d_div_day as VARCHAR(1)) as m_d_div_day, cast(fo.mid_fund_name as VARCHAR(40)) as mid_fund_name, CAST(fo.outsd_fund_num as VARCHAR(8)) as outsd_fund_num, cast(fo.perf_ind as VARCHAR(1)) as fund_perf_indicator,full_price_id as  price_id, cast(proportional_percentage as DECIMAL(3, 2)) as proportional_percentage, CAST(fo.prt_fee_fct as decimal(13, 4)) as prt_fee_fct, CAST(fo.prt_fee_rate as decimal(13, 4)) as prt_fee_rate, cast(qualified_stock_fund_indicator as VARCHAR(1)) as qualified_stock_fund_indicator, CAST(fo.risk_rtn as INTEGER) as fund_risk_rtn, CAST(fo.s_d_div_amt_hi as decimal(13, 4)) as s_d_div_amt_hi, CAST(fo.s_d_div_amt_lo as decimal(13, 4)) as s_d_div_amt_lo, cast(fo.sadv_fee_d_fct as DECIMAL(13, 4)) as sadv_fee_d_fct, cast(fo.sadv_fee_rate as DECIMAL(13, 4)) as sadv_fee_rate, cast(share_price_ind as VARCHAR(1)) as share_price_indicator, case when pfd.source_cycle_date >= to_date('0001-01-01') and pfd.source_cycle_date <= to_date('9999-12-31') then cast(pfd.source_cycle_date as date) else null end as source_cycle_date, cast(null as DATE) as source_processing_date, 'VRP-PB' as source_system, cast(fo.stk_fund_ind as VARCHAR(1)) as stk_indicator, cast(unit_share_price as DECIMAL(11, 6)) as share_price, ticker_symbol, cast(fo.trd_inst_ffam as VARCHAR(40)) as trd_inst_ffam, cast(trust_number as VARCHAR(6)) as trust_number, cast(null as VARCHAR(1)) as shares, cast(value_of_one_share as DECIMAL(11, 6)) as single_share_value,fo.fund_name as fund_ops_fund_name, CAST(fo.yb04_d_fct as decimal(13, 4)) as yb04_d_fct, CAST(fo.yb04_rate as decimal(5, 2)) as yb04_rate, cast(fo.mktg_fund_number as VARCHAR(4)) as mktg_fund_number, stabilizer_gb_fun_investment_id_contract_number as stabi_fund_invest_contract_num FROM exn_xxewre01_xxewrpfd_ng pfd left outer join FO_FUND_TXT fo on coalesce(pfd.fund_code, '-9999') = coalesce(fo.fund_number, '-9999')  left outer join exn_xxewre01_xxewraef_ng aef on coalesce(pfd.client_id, '-9999') = coalesce(aef.client_id, '-9999') and coalesce(pfd.plan_number, '-9999') = coalesce(aef.plan_number, '-9999') and coalesce(pfd.fund_iv, '-9999') = coalesce(left(aef.fund_id, 2), '-9999') order by client_id desc")

    transform_df = exn_xxewre01_xxewrpfd_jb_df.unionByName(exn_xxewre01_xxewrpfd_ng_df)

    return transform_df
